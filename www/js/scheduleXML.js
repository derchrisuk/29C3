// Generated by CoffeeScript 1.3.3
var ScheduleXMLLoader;

ScheduleXMLLoader = (function() {

  function ScheduleXMLLoader() {}

  ScheduleXMLLoader.prototype.loadFromServer = function(programmXMLUrl, doneCallback) {
    return $.ajax({
      url: programmXMLUrl,
      dataType: 'text',
      async: false,
      timeout: 2000
    }).done(function(responseXML) {
      doneCallback(responseXML);
      return alert('Successfully updated schedule.xml from ' + programmXMLUrl);
    }).error(function() {
      throw 'Unable to load from server';
    });
  };

  ScheduleXMLLoader.prototype.appStartUpLoad = function() {
    var currentTimestamp, lastUpdateTimestamp;
    currentTimestamp = Math.round((new Date()).getTime() / 1000);
    lastUpdateTimestamp = userconfig.getItem('schedule_xml_last_update');
    if (!lastUpdateTimestamp || (currentTimestamp - lastUpdateTimestamp > 10800)) {
      try {
        return this.loadFromServer(config.programXMLUrl, function(programXML) {
          $($.parseXML(programXML));
          userconfig.setItem('programXML', programXML);
          return userconfig.setItem('schedule_xml_last_update', currentTimestamp);
        });
      } catch (e) {

      }
    }
  };

  ScheduleXMLLoader.prototype.getXMLTree = function() {
    var programXML, xmlTree;
    programXML = userconfig.getItem('programXML');
    xmlTree = void 0;
    if (!programXML) {
      this.loadFromServer('schedule.xml', function(programXML) {
        return xmlTree = $($.parseXML(programXML));
      });
    } else {
      xmlTree = $($.parseXML(programXML));
    }
    return xmlTree;
  };

  return ScheduleXMLLoader;

})();
