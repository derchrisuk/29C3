// Generated by CoffeeScript 1.4.0
var Event, eventView;

Event = (function() {

  function Event() {}

  Event.page;

  Event.prototype._setField = function(targetElement, value) {
    return targetElement.append(value);
  };

  Event.prototype._resetLayout = function() {
    return $('[data-is-event-field=true]', this.page).each(function() {
      var eventElement;
      eventElement = $(this);
      if (eventElement.find('.tpl').length) {
        return eventElement.children(':not(.tpl)').remove();
      } else {
        return eventElement.html('');
      }
    });
  };

  Event.prototype.initialize = function(eventNode, options) {
    var attendCheckbox, childField, childFieldRound, children, configKey, event, eventField, eventID, eventText, fieldName, liTpl, notesElm, targetElement, _i, _j, _k, _len, _len1, _len2, _liTpl, _liTplLink, _ref, _ref1, _ref2;
    event = this;
    this.page = $('#event');
    this._resetLayout();
    eventID = eventNode.attr('id');
    _ref = eventNode.children();
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      eventField = _ref[_i];
      fieldName = eventField.tagName;
      eventField = $(eventField);
      targetElement = $("#event-" + fieldName, this.page);
      eventText = '';
      children = eventField.children();
      if (fieldName !== 'links') {
        if (children.length > 1) {
          childFieldRound = 0;
          _ref1 = eventField.children();
          for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
            childField = _ref1[_j];
            childFieldRound++;
            if (childFieldRound > 1) {
              eventText += ', ';
            }
            eventText += $(childField).text();
          }
        } else {
          eventText = eventField.text();
        }
      } else {
        liTpl = targetElement.find('li:first').clone().show();
        _ref2 = eventField.children();
        for (_k = 0, _len2 = _ref2.length; _k < _len2; _k++) {
          childField = _ref2[_k];
          childField = $(childField);
          _liTpl = liTpl.clone();
          _liTpl.removeClass('tpl');
          _liTplLink = _liTpl.find('a:first');
          _liTplLink.html(childField.text());
          _liTplLink.attr('href', childField.attr('href'));
          eventText += $('<div/>').append(_liTpl).html();
        }
      }
      this._setField(targetElement, eventText);
    }
    attendCheckbox = $('#event-attend-checkbox').checkboxradio();
    attendCheckbox.attr('data-event-id', eventID);
    attendCheckbox.bind('change', function(event, ui) {
      var self;
      self = $(this);
      eventID = self.attr('data-event-id');
      if (!self.attr('checked')) {
        self.removeAttr('checked').checkboxradio('refresh');
        self.parent().find('.ui-btn-text:first').html(self.attr('data-event-attend-text'));
        $("#event-" + eventID).removeClass('event-attend');
        personalSchedule.db.remove(eventID);
      } else {
        self.attr('checked', 'checked').checkboxradio('refresh');
        self.parent().find('.ui-btn-text:first').html(self.attr('data-event-dontattend-text'));
        $("#event-" + eventID).addClass('event-attend');
        personalSchedule.db.push(eventID);
      }
      return personalScheduleView.initialize();
    });
    if (personalSchedule.db.contains(eventID)) {
      attendCheckbox.attr('checked', 'checked').checkboxradio('refresh');
      attendCheckbox.parent().find('.ui-btn-text:first').html(attendCheckbox.attr('data-event-dontattend-text'));
    } else {
      attendCheckbox.removeAttr('checked').checkboxradio('refresh');
      attendCheckbox.parent().find('.ui-btn-text:first').html(attendCheckbox.attr('data-event-attend-text'));
    }
    configKey = "notes-event-" + eventID;
    notesElm = $('.notes:first', this.page);
    notesElm.attr('data-event-id', eventID);
    notesElm.val(userconfig.getItem(configKey, ''));
    notesElm.keydown(function() {
      return userconfig.setItem(configKey, $(this).val());
    });
    notesElm.blur(function() {
      return userconfig.setItem(configKey, $(this).val());
    });
    return $.mobile.changePage(this.page);
  };

  return Event;

})();

eventView = new Event();
