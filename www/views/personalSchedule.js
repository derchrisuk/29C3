// Generated by CoffeeScript 1.4.0
var PersonalScheduleView, personalScheduleView;

PersonalScheduleView = (function() {

  function PersonalScheduleView() {}

  PersonalScheduleView.page;

  PersonalScheduleView.prototype._resetLayout = function() {
    var contentDiv;
    contentDiv = $('div[data-role=content]:first', this.page);
    return $('ul[data-role=listview]:first', contentDiv).html('');
  };

  PersonalScheduleView.prototype.initialize = function(eventNode, options) {
    var contentDiv, counter, date, dateSplitted, dayNode, event, eventDateKey, eventID, eventsSorted, headerContent, lastHeaderContent, listView, listViewLiElementTpl, listViewLiHeaderTpl, roomNode, start, start_fetched, _i, _j, _len, _len1, _listViewLiElementTpl, _listViewLiElementTplLink, _listViewLiHeaderTpl, _ref, _ref1;
    this.page = $('#personalSchedule');
    this._resetLayout();
    eventsSorted = {};
    counter = 0;
    _ref = personalSchedule.db.getData();
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      eventID = _ref[_i];
      event = $(programXML.find("event[id='" + eventID + "']:first"));
      roomNode = event.parent();
      dayNode = roomNode.parent();
      date = dayNode.attr('date');
      start_fetched = event.find('start:first').text();
      if (!date) {
        continue;
      }
      dateSplitted = date.split('-');
      start = parseFloat(start_fetched.replace(':', '.'));
      if (parseInt(start) < 11) {
        start = start + 24;
      }
      eventsSorted[date + start * 100 + counter] = {
        title: event.find('title:first').text(),
        href: '#event#' + escape(dayNode.attr('index')) + '#' + escape(roomNode.attr('name')) + '#' + escape(eventID),
        start: start_fetched,
        dayForUI: parseInt(dateSplitted[2]) + '. ' + helper.i18nDateFormats.monthNames[parseInt(dateSplitted[1]) - 1]
      };
      counter = counter + 1;
    }
    contentDiv = $('div[data-role=content]:first', this.page);
    listView = $('ul[data-role=listview]:first', contentDiv);
    listViewLiElementTpl = $('.tpl.element:first', contentDiv);
    listViewLiHeaderTpl = $('.tpl.header:first', contentDiv);
    lastHeaderContent = void 0;
    _ref1 = helper.getObjKeys(eventsSorted).sort();
    for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
      eventDateKey = _ref1[_j];
      event = eventsSorted[eventDateKey];
      headerContent = event.dayForUI;
      if (lastHeaderContent !== headerContent) {
        _listViewLiHeaderTpl = listViewLiHeaderTpl.clone().removeClass('tpl');
        _listViewLiHeaderTpl.html(headerContent);
        listView.append(_listViewLiHeaderTpl);
        lastHeaderContent = headerContent;
      }
      _listViewLiElementTpl = listViewLiElementTpl.clone().removeClass('tpl');
      _listViewLiElementTplLink = _listViewLiElementTpl.find('a:first');
      _listViewLiElementTplLink.attr('href', event.href);
      _listViewLiElementTplLink.html(event.start + ' ' + event.title);
      listView.append(_listViewLiElementTpl);
    }
    listView.listview('refresh');
    if (counter > 0) {
      $('#personalSchedule-placeholder').hide();
      $('#personalSchedule-entries').show();
    } else {
      $('#personalSchedule-placeholder').show();
      $('#personalSchedule-entries').hide();
    }
    return $.mobile.changePage(this.page);
  };

  return PersonalScheduleView;

})();

personalScheduleView = new PersonalScheduleView();
